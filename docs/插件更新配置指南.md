# BasePlugin æ’ä»¶æ›´æ–°é…ç½®æŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•ä¸º BasePlugin æ¨¡æ¿é…ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯é…ç½®å’ŒæœåŠ¡å™¨ç«¯å®ç°ã€‚

## ğŸ“‹ å®¢æˆ·ç«¯é…ç½®

### 1. æ›´æ–° manifest.json

åœ¨æ‚¨çš„æ’ä»¶ `manifest.json` æ–‡ä»¶ä¸­æ·»åŠ å®Œæ•´çš„æ›´æ–°é…ç½®ï¼š

```json
{
  "name": "YourPluginName",
  "version": "1.0.0",
  "description": "æ‚¨çš„æ’ä»¶æè¿°",
  "author": "æ‚¨çš„å§“å",
  "email": "your@email.com",
  "website": "https://yourwebsite.com",
  "entry": "YourPlugin.dll",
  "mainClass": "YourPlugin.YourPlugin",
  "minimumHostVersion": "1.0.0",
  "updateInfo": {
    "updateUrl": "https://yourserver.com/api/plugins/update-check",
    "downloadUrl": "https://yourserver.com/api/plugins/download",
    "checkIntervalHours": 24,
    "autoCheck": true,
    "supportedUpdateModes": ["full", "incremental"],
    "backupBeforeUpdate": true,
    "restartRequired": false,
    "verifySignature": false,
    "publicKeyPath": "public.key"
  },
  "changeLog": [
    {
      "version": "1.0.0",
      "date": "2024-12-24",
      "type": "major",
      "changes": [
        "åˆå§‹ç‰ˆæœ¬å‘å¸ƒ",
        "åŸºç¡€åŠŸèƒ½å®ç°"
      ]
    }
  ],
  "settings": [
    {
      "key": "updateCheckEnabled",
      "type": "boolean",
      "default": true,
      "description": "æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ›´æ–°æ£€æŸ¥"
    }
  ]
}
```

### 2. é…ç½®å­—æ®µè¯¦ç»†è¯´æ˜

#### updateInfo å­—æ®µè§£é‡Š

| å­—æ®µå | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `updateUrl` | string | âœ… | - | æ›´æ–°æ£€æŸ¥APIçš„å®Œæ•´URLåœ°å€ |
| `downloadUrl` | string | âŒ | updateUrl | æ›´æ–°åŒ…ä¸‹è½½åœ°å€ï¼ˆå¦‚æœä¸æ£€æŸ¥åœ°å€ä¸åŒï¼‰ |
| `checkIntervalHours` | number | âŒ | 24 | è‡ªåŠ¨æ£€æŸ¥æ›´æ–°çš„é—´éš”æ—¶é—´ï¼ˆå°æ—¶ï¼‰ |
| `autoCheck` | boolean | âŒ | true | æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ›´æ–°æ£€æŸ¥ |
| `supportedUpdateModes` | array | âŒ | ["full"] | æ”¯æŒçš„æ›´æ–°æ¨¡å¼ï¼šfullï¼ˆå…¨é‡ï¼‰, incrementalï¼ˆå¢é‡ï¼‰ |
| `backupBeforeUpdate` | boolean | âŒ | true | æ›´æ–°å‰æ˜¯å¦è‡ªåŠ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬ |
| `restartRequired` | boolean | âŒ | false | æ›´æ–°å®Œæˆåæ˜¯å¦éœ€è¦é‡å¯åº”ç”¨ç¨‹åº |
| `verifySignature` | boolean | âŒ | false | æ˜¯å¦éªŒè¯æ›´æ–°åŒ…çš„æ•°å­—ç­¾å |
| `publicKeyPath` | string | âŒ | null | æ•°å­—ç­¾åéªŒè¯çš„å…¬é’¥æ–‡ä»¶è·¯å¾„ |

#### æ›´æ–°æ¨¡å¼è¯´æ˜

- **fullï¼ˆå…¨é‡æ›´æ–°ï¼‰**ï¼šä¸‹è½½å®Œæ•´çš„æ’ä»¶åŒ…ï¼Œæ›¿æ¢æ‰€æœ‰æ–‡ä»¶
- **incrementalï¼ˆå¢é‡æ›´æ–°ï¼‰**ï¼šä»…ä¸‹è½½ä¿®æ”¹çš„æ–‡ä»¶ï¼ŒèŠ‚çœå¸¦å®½å’Œæ—¶é—´

## ğŸ–¥ï¸ æœåŠ¡å™¨ç«¯å®ç°

### 1. æ›´æ–°æ£€æŸ¥API

åˆ›å»ºä¸€ä¸ªRESTful APIæ¥å¤„ç†æ›´æ–°æ£€æŸ¥è¯·æ±‚ï¼š

#### è¯·æ±‚æ ¼å¼

```
GET /api/plugins/update-check?pluginName={pluginName}&currentVersion={version}
```

**å‚æ•°è¯´æ˜ï¼š**
- `pluginName`: æ’ä»¶åç§°
- `currentVersion`: å½“å‰å®‰è£…çš„ç‰ˆæœ¬å·

#### å“åº”æ ¼å¼

æœåŠ¡å™¨å¿…é¡»è¿”å›ä»¥ä¸‹JSONæ ¼å¼çš„å“åº”ï¼š

```json
{
  "latestVersion": "1.1.0",
  "downloadUrl": "https://yourserver.com/plugins/YourPlugin-v1.1.0.zip",
  "updateMode": "full",
  "fileSize": 1048576,
  "fileHash": "sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
  "isForced": false,
  "releaseNotes": "ç‰ˆæœ¬ 1.1.0 æ›´æ–°å†…å®¹:\n\næ–°å¢åŠŸèƒ½:\n- æ·»åŠ äº†æ•°æ®å¯¼å‡ºåŠŸèƒ½\n- ä¼˜åŒ–äº†ç•Œé¢å“åº”é€Ÿåº¦\n\nä¿®å¤é—®é¢˜:\n- ä¿®å¤äº†åœ¨æŸäº›æƒ…å†µä¸‹çš„å´©æºƒé—®é¢˜\n- è§£å†³äº†å…¼å®¹æ€§é—®é¢˜",
  "releaseDate": "2024-12-24",
  "minCompatibleVersion": "1.0.0"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `latestVersion` | string | âœ… | æœ€æ–°å¯ç”¨ç‰ˆæœ¬å· |
| `downloadUrl` | string | âœ… | æ›´æ–°åŒ…ä¸‹è½½é“¾æ¥ |
| `updateMode` | string | âŒ | æ›´æ–°æ¨¡å¼ï¼š"full" æˆ– "incremental" |
| `fileSize` | number | âŒ | æ›´æ–°åŒ…æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `fileHash` | string | âŒ | æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒå“ˆå¸Œå€¼ |
| `isForced` | boolean | âŒ | æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆä¸å…è®¸è·³è¿‡ï¼‰ |
| `releaseNotes` | string | âŒ | ç‰ˆæœ¬æ›´æ–°è¯´æ˜ï¼Œæ”¯æŒæ¢è¡Œç¬¦ |
| `releaseDate` | string | âŒ | å‘å¸ƒæ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰ |
| `minCompatibleVersion` | string | âŒ | æœ€ä½å…¼å®¹ç‰ˆæœ¬ |

### 2. ASP.NET Core ç¤ºä¾‹å®ç°

```csharp
[ApiController]
[Route("api/plugins")]
public class UpdateController : ControllerBase
{
    private readonly IPluginUpdateService _updateService;
    
    public UpdateController(IPluginUpdateService updateService)
    {
        _updateService = updateService;
    }
    
    [HttpGet("update-check")]
    public async Task<IActionResult> CheckUpdate(
        [FromQuery] string pluginName, 
        [FromQuery] string currentVersion)
    {
        try
        {
            // éªŒè¯å‚æ•°
            if (string.IsNullOrEmpty(pluginName) || string.IsNullOrEmpty(currentVersion))
            {
                return BadRequest("æ’ä»¶åç§°å’Œå½“å‰ç‰ˆæœ¬ä¸èƒ½ä¸ºç©º");
            }
            
            // è·å–æ’ä»¶çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
            var latestInfo = await _updateService.GetLatestVersionAsync(pluginName);
            
            if (latestInfo == null)
            {
                return NotFound("æœªæ‰¾åˆ°æŒ‡å®šæ’ä»¶");
            }
            
            // æ¯”è¾ƒç‰ˆæœ¬å·
            if (IsNewerVersion(latestInfo.Version, currentVersion))
            {
                var response = new
                {
                    latestVersion = latestInfo.Version,
                    downloadUrl = latestInfo.DownloadUrl,
                    updateMode = latestInfo.UpdateMode,
                    fileSize = latestInfo.FileSize,
                    fileHash = $"sha256:{latestInfo.FileHash}",
                    isForced = latestInfo.IsForced,
                    releaseNotes = latestInfo.ReleaseNotes,
                    releaseDate = latestInfo.ReleaseDate.ToString("yyyy-MM-dd"),
                    minCompatibleVersion = latestInfo.MinCompatibleVersion
                };
                
                return Ok(response);
            }
            
            // å·²æ˜¯æœ€æ–°ç‰ˆæœ¬
            return Ok(new { latestVersion = currentVersion });
        }
        catch (Exception ex)
        {
            return StatusCode(500, $"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: {ex.Message}");
        }
    }
    
    private bool IsNewerVersion(string latest, string current)
    {
        return Version.Parse(NormalizeVersion(latest)) > 
               Version.Parse(NormalizeVersion(current));
    }
    
    private string NormalizeVersion(string version)
    {
        // ç§»é™¤ 'v' å‰ç¼€
        if (version.StartsWith("v", StringComparison.OrdinalIgnoreCase))
        {
            version = version.Substring(1);
        }
        
        // ç¡®ä¿ç‰ˆæœ¬å·æœ‰ä¸‰ä½æ•°å­—
        var parts = version.Split('.');
        while (parts.Length < 3)
        {
            version += ".0";
            parts = version.Split('.');
        }
        
        return version;
    }
}
```

### 3. æ•°æ®æ¨¡å‹ç¤ºä¾‹

```csharp
public class PluginVersionInfo
{
    public string PluginName { get; set; }
    public string Version { get; set; }
    public string DownloadUrl { get; set; }
    public string UpdateMode { get; set; } = "full";
    public long FileSize { get; set; }
    public string FileHash { get; set; }
    public bool IsForced { get; set; } = false;
    public string ReleaseNotes { get; set; }
    public DateTime ReleaseDate { get; set; }
    public string MinCompatibleVersion { get; set; }
}

public interface IPluginUpdateService
{
    Task<PluginVersionInfo> GetLatestVersionAsync(string pluginName);
}
```

## ğŸ”’ æ–‡ä»¶å®Œæ•´æ€§éªŒè¯

### 1. æ”¯æŒçš„å“ˆå¸Œç®—æ³•

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹å“ˆå¸Œç®—æ³•è¿›è¡Œæ–‡ä»¶å®Œæ•´æ€§éªŒè¯ï¼š

- **SHA-256**ï¼ˆæ¨èï¼‰ï¼š`sha256:hash_value`
- **SHA-1**ï¼š`sha1:hash_value`
- **MD5**ï¼š`md5:hash_value`

### 2. å“ˆå¸Œå€¼ç”Ÿæˆ

#### Windows PowerShell
```powershell
# SHA-256
Get-FileHash YourPlugin-v1.1.0.zip -Algorithm SHA256

# MD5
Get-FileHash YourPlugin-v1.1.0.zip -Algorithm MD5
```

#### Linux/macOS
```bash
# SHA-256
sha256sum YourPlugin-v1.1.0.zip

# MD5
md5sum YourPlugin-v1.1.0.zip
```

#### Python è„šæœ¬ç¤ºä¾‹
```python
import hashlib

def calculate_sha256(file_path):
    sha256_hash = hashlib.sha256()
    with open(file_path, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            sha256_hash.update(chunk)
    return sha256_hash.hexdigest()

# ä½¿ç”¨
file_hash = calculate_sha256("YourPlugin-v1.1.0.zip")
print(f"sha256:{file_hash}")
```

## ğŸ“¦ æ›´æ–°åŒ…åˆ¶ä½œ

### 1. å…¨é‡æ›´æ–°åŒ…

å…¨é‡æ›´æ–°åŒ…åŒ…å«æ’ä»¶çš„æ‰€æœ‰æ–‡ä»¶ï¼š

```
YourPlugin-v1.1.0.zip
â”œâ”€â”€ YourPlugin.dll
â”œâ”€â”€ manifest.json
â”œâ”€â”€ README.md
â”œâ”€â”€ Dependencies/
â”‚   â”œâ”€â”€ Library1.dll
â”‚   â””â”€â”€ Library2.dll
â””â”€â”€ Resources/
    â”œâ”€â”€ icon.png
    â””â”€â”€ config.json
```

### 2. å¢é‡æ›´æ–°åŒ…

å¢é‡æ›´æ–°åŒ…ä»…åŒ…å«ä¿®æ”¹çš„æ–‡ä»¶ï¼š

```
YourPlugin-v1.1.0-incremental.zip
â”œâ”€â”€ YourPlugin.dll          # ä¸»ç¨‹åºå·²æ›´æ–°
â”œâ”€â”€ manifest.json           # ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°
â””â”€â”€ Dependencies/
    â””â”€â”€ Library1.dll        # ä»…æ­¤ä¾èµ–åº“æœ‰æ›´æ–°
```

### 3. è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

#### PowerShell è„šæœ¬ç¤ºä¾‹
```powershell
param(
    [Parameter(Mandatory=$true)]
    [string]$Version,
    
    [Parameter(Mandatory=$true)]
    [string]$ProjectPath
)

# æ„å»ºé¡¹ç›®
dotnet build $ProjectPath -c Release

# åˆ›å»ºæ›´æ–°åŒ…
$outputPath = ".\releases\YourPlugin-v$Version.zip"
$sourcePath = ".\bin\Release\net481\*"

Compress-Archive -Path $sourcePath -DestinationPath $outputPath -Force

# ç”Ÿæˆå“ˆå¸Œå€¼
$hash = Get-FileHash $outputPath -Algorithm SHA256
Write-Host "File: $outputPath"
Write-Host "Hash: sha256:$($hash.Hash.ToLower())"
Write-Host "Size: $((Get-Item $outputPath).Length) bytes"
```

## ğŸ” ç‰ˆæœ¬å·ç®¡ç†

### 1. æ”¯æŒçš„ç‰ˆæœ¬å·æ ¼å¼

- **è¯­ä¹‰åŒ–ç‰ˆæœ¬å·**ï¼š`1.0.0`, `1.2.3`, `2.0.0-beta.1`
- **ç®€åŒ–ç‰ˆæœ¬å·**ï¼š`1.0`, `1` (è‡ªåŠ¨è¡¥å…¨ä¸º `1.0.0`)
- **å¸¦å‰ç¼€ç‰ˆæœ¬å·**ï¼š`v1.0.0` (è‡ªåŠ¨ç§»é™¤å‰ç¼€)

### 2. ç‰ˆæœ¬æ¯”è¾ƒè§„åˆ™

ç‰ˆæœ¬æ¯”è¾ƒéµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™ï¼š
- ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·
- é¢„å‘å¸ƒç‰ˆæœ¬ï¼š`1.0.0-alpha.1`
- æ„å»ºå…ƒæ•°æ®ï¼š`1.0.0+20240324`

### 3. æœ€ä½³å®è·µ

1. **ä¸»ç‰ˆæœ¬å·**ï¼šä¸å…¼å®¹çš„APIä¿®æ”¹
2. **æ¬¡ç‰ˆæœ¬å·**ï¼šå‘åå…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
3. **ä¿®è®¢å·**ï¼šå‘åå…¼å®¹çš„é—®é¢˜ä¿®æ­£

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•

### 1. éƒ¨ç½²æ¸…å•

- [ ] éƒ¨ç½²æ›´æ–°æ£€æŸ¥APIæœåŠ¡å™¨
- [ ] é…ç½®æ–‡ä»¶ä¸‹è½½æœåŠ¡
- [ ] å‡†å¤‡SSLè¯ä¹¦ï¼ˆHTTPSï¼‰
- [ ] è®¾ç½®CDNåŠ é€Ÿï¼ˆå¯é€‰ï¼‰
- [ ] é…ç½®æ—¥å¿—å’Œç›‘æ§

### 2. æµ‹è¯•æµç¨‹

1. **æœ¬åœ°æµ‹è¯•**ï¼š
   - ä¿®æ”¹manifest.jsonä¸­çš„ç‰ˆæœ¬å·
   - æµ‹è¯•æ›´æ–°æ£€æŸ¥API
   - éªŒè¯æ›´æ–°åŒ…ä¸‹è½½

2. **é›†æˆæµ‹è¯•**ï¼š
   - éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ
   - æ¨¡æ‹Ÿç‰ˆæœ¬å‡çº§
   - éªŒè¯å›æ»šæœºåˆ¶

3. **ç”Ÿäº§éƒ¨ç½²**ï¼š
   - é€æ­¥å‘å¸ƒ
   - ç›‘æ§æ›´æ–°æˆåŠŸç‡
   - æ”¶é›†ç”¨æˆ·åé¦ˆ

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

1. **æ›´æ–°æ£€æŸ¥å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯APIåœ°å€æ­£ç¡®æ€§
   - ç¡®è®¤æœåŠ¡å™¨å“åº”æ ¼å¼

2. **æ–‡ä»¶ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥downloadUrlå¯è®¿é—®æ€§
   - éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§
   - ç¡®è®¤ç½‘ç»œé˜²ç«å¢™è®¾ç½®

3. **å“ˆå¸ŒéªŒè¯å¤±è´¥**
   - é‡æ–°ç”Ÿæˆæ–‡ä»¶å“ˆå¸Œ
   - æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
   - éªŒè¯å“ˆå¸Œç®—æ³•åŒ¹é…

4. **ç‰ˆæœ¬æ¯”è¾ƒé”™è¯¯**
   - ç¡®è®¤ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®
   - æ£€æŸ¥è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™
   - éªŒè¯ç‰ˆæœ¬è§£æé€»è¾‘

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
3. éªŒè¯æœåŠ¡å™¨é…ç½®å’ŒAPIå“åº”
4. è®¿é—® [åšå®¢å®˜ç½‘](https://www.90le.cn) è·å–å¸®åŠ©
5. å‘é€é‚®ä»¶è‡³ 767759678@qq.com
6. è”ç³»ä½œè€…å¾®ä¿¡ binStudy
---

**ç¥æ‚¨çš„æ’ä»¶æ›´æ–°åŠŸèƒ½é…ç½®é¡ºåˆ©ï¼** ğŸ‰ 