# ğŸ“ æ’ä»¶æ—¥å¿—ç®¡ç†å™¨å®Œæ•´æŒ‡å—

## ğŸ¯ æ¦‚è¿°

DTI_Tool.AddIn æ¡†æ¶é€šè¿‡ `IHostApplication` æ¥å£ä¸ºæ’ä»¶æä¾›äº†ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†åŠŸèƒ½ã€‚æ’ä»¶å¯ä»¥é€šè¿‡æ­¤æ¥å£è®°å½•å„ç§çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯ï¼Œè¿›è¡Œæ€§èƒ½æµ‹é‡ï¼Œå¹¶ä¸å®¿ä¸»åº”ç”¨çš„æ—¥å¿—ç³»ç»Ÿå®Œå…¨é›†æˆã€‚

## ğŸ”Œ IHostApplication æ—¥å¿—æ¥å£

### æ¥å£å®šä¹‰

`IHostApplication` æ¥å£æä¾›äº†ä»¥ä¸‹æ—¥å¿—ç›¸å…³æ–¹æ³•ï¼š

```csharp
public interface IHostApplication
{
    // åŸºç¡€æ—¥å¿—è®°å½•æ–¹æ³•
    void LogDebug(string pluginName, string message);
    void LogInfo(string pluginName, string message);
    void LogWarning(string pluginName, string message);
    void LogError(string pluginName, string message);
    void LogError(string pluginName, Exception exception, string message);
    
    // æ ¼å¼åŒ–æ—¥å¿—è®°å½•æ–¹æ³•
    void LogDebugFormat(string pluginName, string format, params object[] args);
    void LogInfoFormat(string pluginName, string format, params object[] args);
    void LogWarningFormat(string pluginName, string format, params object[] args);
    void LogErrorFormat(string pluginName, string format, params object[] args);
    void LogErrorFormat(string pluginName, Exception exception, string format, params object[] args);
    
    // æ—¥å¿—çº§åˆ«æ£€æŸ¥å±æ€§
    bool IsDebugEnabled { get; }
    bool IsInfoEnabled { get; }
    bool IsWarningEnabled { get; }
    bool IsErrorEnabled { get; }
    
    // æ€§èƒ½æµ‹é‡æ–¹æ³•
    IDisposable StartPerformanceMeasure(string pluginName, string operationName);
    
    // å…¶ä»–å®¿ä¸»åŠŸèƒ½...
}
```

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ’ä»¶æ ‡è¯†**: æ¯ä¸ªæ—¥å¿—è®°å½•éƒ½ä¼šè‡ªåŠ¨æ ‡è¯†æ¥æºæ’ä»¶
- âœ… **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰æ’ä»¶æ—¥å¿—ç»Ÿä¸€åˆ°å®¿ä¸»çš„æ—¥å¿—æŸ¥çœ‹å™¨
- âœ… **å®æ—¶ç›‘æ§**: æ”¯æŒå®æ—¶æŸ¥çœ‹å’Œè¿‡æ»¤æ’ä»¶æ—¥å¿—
- âœ… **æ€§èƒ½æµ‹é‡**: å†…ç½®é«˜ç²¾åº¦æ€§èƒ½æµ‹é‡åŠŸèƒ½
- âœ… **å¼‚å¸¸å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯è®°å½•å’Œä¸Šä¸‹æ–‡ä¿å­˜

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è·å–å®¿ä¸»åº”ç”¨æ¥å£

åœ¨æ’ä»¶çš„ `Initialize` æ–¹æ³•ä¸­ï¼Œå®¿ä¸»åº”ç”¨ä¼šè‡ªåŠ¨ä¼ é€’ `IHostApplication` æ¥å£ï¼š

```csharp
public class MyExcelPlugin : IPlugin
{
    private IHostApplication _hostApplication;
    
    public void Initialize()
    {
        // _hostApplication åœ¨æ­¤æ—¶å·²ç»å¯ç”¨
        _hostApplication.LogInfo(Name, "æ’ä»¶å¼€å§‹åˆå§‹åŒ–");
        
        try
        {
            // åˆå§‹åŒ–ä»£ç ...
            
            _hostApplication.LogInfo(Name, "æ’ä»¶åˆå§‹åŒ–æˆåŠŸ");
        }
        catch (Exception ex)
        {
            _hostApplication.LogError(Name, ex, "æ’ä»¶åˆå§‹åŒ–å¤±è´¥");
            throw;
        }
    }
}
```

### 2. åŸºæœ¬æ—¥å¿—è®°å½•

```csharp
public void MyFeature()
{
    // è®°å½•è°ƒè¯•ä¿¡æ¯
    _hostApplication.LogDebug(Name, "å¼€å§‹æ‰§è¡Œç”¨æˆ·åŠŸèƒ½");
    
    // è®°å½•ä¸€èˆ¬ä¿¡æ¯
    _hostApplication.LogInfo(Name, "ç”¨æˆ·æ‰§è¡Œäº† MyFeature åŠŸèƒ½");
    
    // è®°å½•è­¦å‘Šä¿¡æ¯
    if (someCondition)
    {
        _hostApplication.LogWarning(Name, "æ£€æµ‹åˆ°æ½œåœ¨é—®é¢˜ï¼Œä½†ç»§ç»­æ‰§è¡Œ");
    }
    
    // è®°å½•é”™è¯¯ä¿¡æ¯
    try
    {
        // ä¸šåŠ¡é€»è¾‘
    }
    catch (Exception ex)
    {
        _hostApplication.LogError(Name, ex, "åŠŸèƒ½æ‰§è¡Œå¤±è´¥");
        throw;
    }
}
```

### 3. æ ¼å¼åŒ–æ—¥å¿—è®°å½•

```csharp
public void ProcessData(int totalRows)
{
    // ä½¿ç”¨æ ¼å¼åŒ–æ–¹æ³•è®°å½•æ—¥å¿—ï¼Œæ€§èƒ½æ›´å¥½
    _hostApplication.LogInfoFormat(Name, "å¼€å§‹å¤„ç†æ•°æ®ï¼Œæ€»è¡Œæ•°: {0}", totalRows);
    
    int processed = 0;
    int errors = 0;
    
    for (int i = 0; i < totalRows; i++)
    {
        try
        {
            ProcessRow(i);
            processed++;
            
            // å®šæœŸæŠ¥å‘Šè¿›åº¦
            if (i % 1000 == 0)
            {
                _hostApplication.LogDebugFormat(Name, "å¤„ç†è¿›åº¦: {0}/{1} ({2:P1})", 
                    i, totalRows, (double)i / totalRows);
            }
        }
        catch (Exception ex)
        {
            errors++;
            _hostApplication.LogErrorFormat(Name, ex, "å¤„ç†ç¬¬ {0} è¡Œæ—¶å‘ç”Ÿé”™è¯¯", i + 1);
        }
    }
    
    _hostApplication.LogInfoFormat(Name, "æ•°æ®å¤„ç†å®Œæˆ - æˆåŠŸ: {0}, å¤±è´¥: {1}", processed, errors);
}
```

### 4. æ¡ä»¶æ—¥å¿—è®°å½•

```csharp
public void DetailedOperation()
{
    // æ£€æŸ¥æ—¥å¿—çº§åˆ«é¿å…ä¸å¿…è¦çš„å­—ç¬¦ä¸²æ“ä½œ
    if (_hostApplication.IsDebugEnabled)
    {
        var complexData = GenerateComplexDebugInfo(); // åªåœ¨éœ€è¦æ—¶ç”Ÿæˆ
        _hostApplication.LogDebugFormat(Name, "è¯¦ç»†è°ƒè¯•ä¿¡æ¯: {0}", complexData);
    }
    
    // å¯¹äºç®€å•æ¶ˆæ¯å¯ä»¥ç›´æ¥è®°å½•
    _hostApplication.LogInfo(Name, "æ‰§è¡Œè¯¦ç»†æ“ä½œ");
}
```

### 5. æ€§èƒ½æµ‹é‡

```csharp
public void ProcessLargeData()
{
    using (_hostApplication.StartPerformanceMeasure(Name, "å¤§æ•°æ®å¤„ç†"))
    {
        // éœ€è¦æµ‹é‡æ€§èƒ½çš„ä»£ç 
        for (int i = 0; i < 10000; i++)
        {
            ProcessDataItem(i);
        }
    }
    // æ€§èƒ½æµ‹é‡ä¼šè‡ªåŠ¨è®°å½•åˆ°æ—¥å¿—ä¸­
}
```

## ğŸ“Š æ—¥å¿—çº§åˆ«è¯¦è§£

### ğŸ” Debug - è°ƒè¯•ä¿¡æ¯

**ç”¨é€”**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»…åœ¨å¼€å‘è°ƒè¯•æ—¶ä½¿ç”¨

**ç¤ºä¾‹**:
```csharp
_hostApplication.LogDebug(Name, $"å¤„ç†å•å…ƒæ ¼ {cellAddress}ï¼Œå½“å‰å€¼: {cellValue}");
_hostApplication.LogDebug(Name, $"éå†å·¥ä½œè¡¨ï¼Œå½“å‰ç´¢å¼•: {index}/{total}");
```

**ç‰¹ç‚¹**:
- ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½è¢«è¿‡æ»¤
- åŒ…å«è¯¦ç»†çš„ç¨‹åºæ‰§è¡ŒçŠ¶æ€
- æœ‰åŠ©äºé—®é¢˜å®šä½å’Œç¨‹åºç†è§£

### â„¹ï¸ Info - ä¸€èˆ¬ä¿¡æ¯

**ç”¨é€”**: è®°å½•é‡è¦çš„æ“ä½œå’ŒçŠ¶æ€å˜åŒ–

**ç¤ºä¾‹**:
```csharp
_hostApplication.LogInfo(Name, "å¼€å§‹å¯¼å…¥ Excel æ–‡ä»¶");
_hostApplication.LogInfo(Name, $"æˆåŠŸå¤„ç† {processedCount} æ¡è®°å½•");
_hostApplication.LogInfo(Name, "ç”¨æˆ·è§¦å‘äº†æ•°æ®å¯¼å‡ºåŠŸèƒ½");
```

**ç‰¹ç‚¹**:
- è®°å½•å…³é”®ä¸šåŠ¡æ“ä½œ
- ç”¨äºå®¡è®¡å’Œæ“ä½œè·Ÿè¸ª
- æ­£å¸¸è¿è¡Œæ—¶çš„ä¸»è¦æ—¥å¿—çº§åˆ«

### âš ï¸ Warning - è­¦å‘Šä¿¡æ¯

**ç”¨é€”**: è®°å½•éœ€è¦æ³¨æ„ä½†ä¸å½±å“æ­£å¸¸è¿è¡Œçš„é—®é¢˜

**ç¤ºä¾‹**:
```csharp
_hostApplication.LogWarning(Name, "é…ç½®æ–‡ä»¶ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤é…ç½®");
_hostApplication.LogWarning(Name, $"å‘ç° {invalidCount} ä¸ªæ— æ•ˆæ•°æ®ï¼Œå·²è·³è¿‡");
_hostApplication.LogWarning(Name, "æ£€æµ‹åˆ°å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜: 85%");
```

**ç‰¹ç‚¹**:
- æ ‡è¯†æ½œåœ¨é—®é¢˜
- ä¸ä¸­æ–­ç¨‹åºæ‰§è¡Œ
- éœ€è¦åç»­å…³æ³¨æˆ–å¤„ç†

### âŒ Error - é”™è¯¯ä¿¡æ¯

**ç”¨é€”**: è®°å½•å½±å“åŠŸèƒ½æ­£å¸¸è¿è¡Œçš„é”™è¯¯

**ç¤ºä¾‹**:
```csharp
// ç®€å•é”™è¯¯ä¿¡æ¯
_hostApplication.LogError(Name, "æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œç£ç›˜ç©ºé—´ä¸è¶³");

// å¸¦å¼‚å¸¸çš„é”™è¯¯ä¿¡æ¯
try
{
    ProcessData();
}
catch (Exception ex)
{
    _hostApplication.LogError(Name, ex, "æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸");
}
```

**ç‰¹ç‚¹**:
- è®°å½•å®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
- åŒ…å«é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯
- éœ€è¦ç«‹å³å…³æ³¨å’Œå¤„ç†

## â±ï¸ æ€§èƒ½æµ‹é‡è¯¦è§£

### åŸºæœ¬ç”¨æ³•

```csharp
using (_hostApplication.StartPerformanceMeasure(Name, "æ“ä½œåç§°"))
{
    // éœ€è¦æµ‹é‡çš„ä»£ç 
}
```

### åµŒå¥—æµ‹é‡

```csharp
using (_hostApplication.StartPerformanceMeasure(Name, "å®Œæ•´æµç¨‹"))
{
    using (_hostApplication.StartPerformanceMeasure(Name, "æ•°æ®éªŒè¯"))
    {
        ValidateData();
    }
    
    using (_hostApplication.StartPerformanceMeasure(Name, "æ•°æ®å¤„ç†"))
    {
        ProcessData();
    }
    
    using (_hostApplication.StartPerformanceMeasure(Name, "ç»“æœè¾“å‡º"))
    {
        OutputResults();
    }
}
```

### æµ‹é‡ç»“æœ

æ€§èƒ½æµ‹é‡ç»“æœä¼šè‡ªåŠ¨è®°å½•åˆ°æ—¥å¿—ä¸­ï¼š

```
[INFO] å®Œæˆæ‰§è¡Œ: æ•°æ®éªŒè¯, è€—æ—¶: 156ms
[INFO] å®Œæˆæ‰§è¡Œ: æ•°æ®å¤„ç†, è€—æ—¶: 2.3s
[INFO] å®Œæˆæ‰§è¡Œ: ç»“æœè¾“å‡º, è€—æ—¶: 89ms
[INFO] å®Œæˆæ‰§è¡Œ: å®Œæ•´æµç¨‹, è€—æ—¶: 2.6s
```

## ğŸ—ï¸ æœ€ä½³å®è·µ

### 1. æ—¥å¿—è®°å½•ç­–ç•¥

```csharp
public class DataProcessor
{
    private readonly IHostApplication _hostApplication;
    private readonly string _pluginName;
    
    public DataProcessor(IHostApplication hostApplication, string pluginName)
    {
        _hostApplication = hostApplication;
        _pluginName = pluginName;
    }
    
    public void ProcessExcelData(Excel.Workbook workbook)
    {
        // è®°å½•æ“ä½œå¼€å§‹
        _hostApplication.LogInfo(_pluginName, $"å¼€å§‹å¤„ç†å·¥ä½œç°¿: {workbook.Name}");
        
        try
        {
            using (_hostApplication.StartPerformanceMeasure(_pluginName, "Excelæ•°æ®å¤„ç†"))
            {
                foreach (Excel.Worksheet sheet in workbook.Worksheets)
                {
                    ProcessWorksheet(sheet);
                }
            }
            
            _hostApplication.LogInfo(_pluginName, "æ•°æ®å¤„ç†å®Œæˆ");
        }
        catch (Exception ex)
        {
            _hostApplication.LogError(_pluginName, ex, "æ•°æ®å¤„ç†å¤±è´¥");
            throw;
        }
    }
    
    private void ProcessWorksheet(Excel.Worksheet sheet)
    {
        _hostApplication.LogDebug(_pluginName, $"å¼€å§‹å¤„ç†å·¥ä½œè¡¨: {sheet.Name}");
        
        var usedRange = sheet.UsedRange;
        if (usedRange == null)
        {
            _hostApplication.LogWarning(_pluginName, $"å·¥ä½œè¡¨ '{sheet.Name}' æ²¡æœ‰æ•°æ®");
            return;
        }
        
        _hostApplication.LogInfo(_pluginName, 
            $"å¤„ç†å·¥ä½œè¡¨ '{sheet.Name}', èŒƒå›´: {usedRange.Address}");
        
        // å¤„ç†é€»è¾‘...
    }
}
```

### 2. é”™è¯¯å¤„ç†æ¨¡å¼

```csharp
public void SafeOperation()
{
    try
    {
        _hostApplication.LogInfo(Name, "å¼€å§‹æ‰§è¡Œå®‰å…¨æ“ä½œ");
        
        // å¯èƒ½å¤±è´¥çš„æ“ä½œ
        RiskyOperation();
        
        _hostApplication.LogInfo(Name, "å®‰å…¨æ“ä½œæ‰§è¡ŒæˆåŠŸ");
    }
    catch (ArgumentException ex)
    {
        // å¯é¢„æœŸçš„é”™è¯¯
        _hostApplication.LogWarning(Name, $"å‚æ•°é”™è¯¯: {ex.Message}");
        throw new InvalidOperationException("æ“ä½œå‚æ•°ä¸æ­£ç¡®", ex);
    }
    catch (System.IO.IOException ex)
    {
        // å¯æ¢å¤çš„é”™è¯¯
        _hostApplication.LogError(Name, ex, "æ–‡ä»¶æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™");
        throw;
    }
    catch (Exception ex)
    {
        // æœªé¢„æœŸçš„é”™è¯¯
        _hostApplication.LogError(Name, ex, "æ‰§è¡Œå®‰å…¨æ“ä½œæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯");
        throw;
    }
}
```

### 3. æ ¼å¼åŒ–æ—¥å¿—çš„æ€§èƒ½ä¼˜åŠ¿

```csharp
// âœ… æ¨èï¼šä½¿ç”¨Formatæ–¹æ³•ï¼Œæ€§èƒ½æœ€ä½³
_hostApplication.LogInfoFormat(Name, "å¤„ç†äº† {0} æ¡è®°å½•ï¼ŒæˆåŠŸ: {1}, å¤±è´¥: {2}", count, success, failed);
_hostApplication.LogDebugFormat(Name, "å½“å‰è¿›åº¦: {0}/{1} ({2:P1})", current, total, (double)current / total);

// âœ… å¯æ¥å—ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ’å€¼ï¼Œæ€§èƒ½è‰¯å¥½
_hostApplication.LogInfo(Name, $"å¤„ç†äº† {count} æ¡è®°å½•ï¼ŒæˆåŠŸ: {success}, å¤±è´¥: {failed}");

// âŒ é¿å…ï¼šå­—ç¬¦ä¸²è¿æ¥ï¼Œæ€§èƒ½è¾ƒå·®
_hostApplication.LogInfo(Name, "å¤„ç†äº†" + count + "æ¡è®°å½•"); 
```

### 4. æ¡ä»¶æ—¥å¿—è®°å½•ä¼˜åŒ–

```csharp
// âœ… æ¨èï¼šå¤æ‚è°ƒè¯•ä¿¡æ¯ä½¿ç”¨æ¡ä»¶æ£€æŸ¥
if (_hostApplication.IsDebugEnabled)
{
    var complexInfo = BuildComplexDebugInfo(); // åªåœ¨éœ€è¦æ—¶æ‰§è¡Œ
    _hostApplication.LogDebugFormat(Name, "å¤æ‚è°ƒè¯•ä¿¡æ¯: {0}", complexInfo);
}

// âœ… æ¨èï¼šç®€å•æ¶ˆæ¯ç›´æ¥è®°å½•
_hostApplication.LogInfo(Name, "æ“ä½œå¼€å§‹");

// âŒ é¿å…ï¼šä¸å¿…è¦çš„æ¡ä»¶æ£€æŸ¥
if (_hostApplication.IsInfoEnabled) // Infoçº§åˆ«é€šå¸¸æ€»æ˜¯å¯ç”¨çš„
{
    _hostApplication.LogInfo(Name, "ç®€å•æ¶ˆæ¯");
}
```

### 5. é¿å…è¿‡åº¦æ—¥å¿—è®°å½•

```csharp
// âŒ é¿å…åœ¨å¾ªç¯ä¸­è¿‡åº¦è®°å½•
for (int i = 0; i < 10000; i++)
{
    _hostApplication.LogDebug(Name, $"å¤„ç†ç¬¬ {i} é¡¹"); // ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—
}

// âœ… æ¨èçš„åšæ³•
_hostApplication.LogInfo(Name, $"å¼€å§‹å¤„ç† {totalCount} ä¸ªé¡¹ç›®");
for (int i = 0; i < totalCount; i++)
{
    ProcessItem(i);
    
    // å®šæœŸæŠ¥å‘Šè¿›åº¦
    if (i % 1000 == 0)
    {
        _hostApplication.LogDebug(Name, $"å·²å¤„ç† {i}/{totalCount} é¡¹");
    }
}
_hostApplication.LogInfo(Name, $"å¤„ç†å®Œæˆï¼ŒæˆåŠŸ: {successCount}, å¤±è´¥: {failCount}");
```

## ğŸ” æ—¥å¿—æŸ¥çœ‹å’Œç›‘æ§

### åœ¨å®¿ä¸»åº”ç”¨ä¸­æŸ¥çœ‹æ—¥å¿—

1. **æ‰“å¼€æ—¥å¿—æŸ¥çœ‹å™¨**:
   - åœ¨ Excel åŠŸèƒ½åŒºæ‰¾åˆ° "DTI Tool"
   - ç‚¹å‡» "è°ƒè¯•å·¥å…·" ç»„ä¸­çš„ "æ—¥å¿—æŸ¥çœ‹å™¨"

2. **è¿‡æ»¤æ’ä»¶æ—¥å¿—**:
   - åœ¨æ’ä»¶è¿‡æ»¤å™¨ä¸­é€‰æ‹©æ‚¨çš„æ’ä»¶åç§°
   - åªæ˜¾ç¤ºæ¥è‡ªè¯¥æ’ä»¶çš„æ—¥å¿—è®°å½•

3. **çº§åˆ«è¿‡æ»¤**:
   - é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥å¿—çº§åˆ«
   - ä¸“æ³¨äº Error å’Œ Warning çº§åˆ«è¿›è¡Œé—®é¢˜è¯Šæ–­

4. **æœç´¢åŠŸèƒ½**:
   - ä½¿ç”¨æœç´¢æ¡†æŸ¥æ‰¾ç‰¹å®šçš„æ“ä½œæˆ–é”™è¯¯
   - æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æœç´¢

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[2024-01-15 14:30:15.123] [INFO] [BasePlugin] æ’ä»¶åˆå§‹åŒ–æˆåŠŸ
[2024-01-15 14:30:18.456] [DEBUG] [BasePlugin] å¼€å§‹å¤„ç†å·¥ä½œè¡¨: Sheet1
[2024-01-15 14:30:20.789] [WARNING] [BasePlugin] å‘ç° 3 ä¸ªç©ºå•å…ƒæ ¼ï¼Œå·²è·³è¿‡
[2024-01-15 14:30:22.101] [INFO] [BasePlugin] å®Œæˆæ‰§è¡Œ: æ•°æ®å¤„ç†, è€—æ—¶: 1.5s
[2024-01-15 14:30:25.234] [ERROR] [BasePlugin] æ–‡ä»¶ä¿å­˜å¤±è´¥
Exception: System.IO.IOException
Message: ç£ç›˜ç©ºé—´ä¸è¶³
StackTrace: at System.IO.File.WriteAllText(...)
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæˆ‘çš„æ—¥å¿—æ²¡æœ‰æ˜¾ç¤ºï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ’ä»¶åç§°
- æ£€æŸ¥æ—¥å¿—çº§åˆ«è¿‡æ»¤è®¾ç½®
- ç¡®è®¤å®¿ä¸»åº”ç”¨çš„æ—¥å¿—åŠŸèƒ½å·²å¯ç”¨

**Q: æ€§èƒ½æµ‹é‡æ˜¾ç¤ºçš„æ—¶é—´ä¸å‡†ç¡®ï¼Ÿ**

A: ç¡®ä¿ï¼š
- æ­£ç¡®ä½¿ç”¨ `using` è¯­å¥
- ä¸è¦åœ¨æµ‹é‡ä»£ç ä¸­åŒ…å«UIæ“ä½œ
- é¿å…åµŒå¥—è¿‡æ·±çš„æ€§èƒ½æµ‹é‡

**Q: å¼‚å¸¸ä¿¡æ¯ä¸å®Œæ•´ï¼Ÿ**

A: ä½¿ç”¨å¸¦å¼‚å¸¸å‚æ•°çš„é‡è½½æ–¹æ³•ï¼š
```csharp
catch (Exception ex)
{
    _hostApplication.LogError(Name, ex, "æ“ä½œå¤±è´¥");  // âœ… æ­£ç¡®
    // è€Œä¸æ˜¯
    _hostApplication.LogError(Name, ex.Message);      // âŒ ä¿¡æ¯ä¸å®Œæ•´
}
```

### è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨åˆ†çº§æ—¥å¿—**: å¼€å‘æ—¶ä½¿ç”¨ Debug çº§åˆ«ï¼Œç”Ÿäº§æ—¶ä½¿ç”¨ Info çº§åˆ«
2. **æ·»åŠ ä¸Šä¸‹æ–‡**: åœ¨æ—¥å¿—ä¸­åŒ…å«æ“ä½œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
3. **æ€§èƒ½ç›‘æ§**: å¯¹å…³é”®æ“ä½œè¿›è¡Œæ€§èƒ½æµ‹é‡
4. **å¼‚å¸¸é“¾**: ä¿æŒå¼‚å¸¸çš„å®Œæ•´è°ƒç”¨é“¾

## ğŸ“š å®Œæ•´ç¤ºä¾‹

```csharp
using System;
using DTI_Tool.AddIn.Common.Interfaces;
using Excel = Microsoft.Office.Interop.Excel;

public class ExcelDataImporter
{
    private readonly IHostApplication _hostApplication;
    private readonly string _pluginName;
    
    public ExcelDataImporter(IHostApplication hostApplication, string pluginName)
    {
        _hostApplication = hostApplication ?? throw new ArgumentNullException(nameof(hostApplication));
        _pluginName = pluginName;
    }
    
    public void ImportData(string filePath)
    {
        _hostApplication.LogInfoFormat(_pluginName, "å¼€å§‹å¯¼å…¥æ•°æ®æ–‡ä»¶: {0}", filePath);
        
        using (_hostApplication.StartPerformanceMeasure(_pluginName, "æ•°æ®å¯¼å…¥"))
        {
            try
            {
                                 if (!System.IO.File.Exists(filePath))
                 {
                     _hostApplication.LogWarningFormat(_pluginName, "æ–‡ä»¶ä¸å­˜åœ¨: {0}", filePath);
                     return;
                 }
                
                var excelApp = _hostApplication.ExcelApplication;
                Excel.Workbook workbook = null;
                
                try
                {
                    using (_hostApplication.StartPerformanceMeasure(_pluginName, "æ‰“å¼€å·¥ä½œç°¿"))
                    {
                        workbook = excelApp.Workbooks.Open(filePath);
                    }
                    
                                         if (_hostApplication.IsDebugEnabled)
                     {
                         _hostApplication.LogDebugFormat(_pluginName, "æˆåŠŸæ‰“å¼€å·¥ä½œç°¿: {0}", workbook.Name);
                     }
                     
                     ProcessWorkbook(workbook);
                     
                     _hostApplication.LogInfo(_pluginName, "æ•°æ®å¯¼å…¥å®Œæˆ");
                }
                finally
                {
                    if (workbook != null)
                    {
                        workbook.Close(false);
                        _hostApplication.LogDebug(_pluginName, "å·²å…³é—­å·¥ä½œç°¿");
                    }
                }
            }
                         catch (Exception ex)
             {
                 _hostApplication.LogErrorFormat(_pluginName, ex, "æ•°æ®å¯¼å…¥å¤±è´¥: {0}", filePath);
                 throw;
             }
        }
    }
    
    private void ProcessWorkbook(Excel.Workbook workbook)
    {
        using (_hostApplication.StartPerformanceMeasure(_pluginName, "å¤„ç†å·¥ä½œç°¿"))
        {
            foreach (Excel.Worksheet sheet in workbook.Worksheets)
            {
                ProcessWorksheet(sheet);
            }
        }
    }
    
    private void ProcessWorksheet(Excel.Worksheet sheet)
    {
        using (_hostApplication.StartPerformanceMeasure(_pluginName, $"å¤„ç†å·¥ä½œè¡¨ {sheet.Name}"))
        {
                     if (_hostApplication.IsDebugEnabled)
         {
             _hostApplication.LogDebugFormat(_pluginName, "å¼€å§‹å¤„ç†å·¥ä½œè¡¨: {0}", sheet.Name);
         }
         
         var usedRange = sheet.UsedRange;
         if (usedRange == null)
         {
             _hostApplication.LogWarningFormat(_pluginName, "å·¥ä½œè¡¨ '{0}' æ²¡æœ‰æ•°æ®", sheet.Name);
             return;
         }
         
         _hostApplication.LogInfoFormat(_pluginName, 
             "å·¥ä½œè¡¨ '{0}' æ•°æ®èŒƒå›´: {1}, è¡Œæ•°: {2}, åˆ—æ•°: {3}",
             sheet.Name, usedRange.Address, usedRange.Rows.Count, usedRange.Columns.Count);
            
            try
            {
                var values = usedRange.Value2;
                if (values != null)
                {
                    ProcessData(values);
                }
            }
                         catch (Exception ex)
             {
                 _hostApplication.LogErrorFormat(_pluginName, ex, "å¤„ç†å·¥ä½œè¡¨ '{0}' æ—¶å‘ç”Ÿé”™è¯¯", sheet.Name);
                 throw;
             }
        }
    }
    
    private void ProcessData(object[,] data)
    {
        // æ•°æ®å¤„ç†é€»è¾‘
        _hostApplication.LogDebug(_pluginName, "å¼€å§‹å¤„ç†æ•°æ®æ•°ç»„");
        
        // å¤„ç†é€»è¾‘...
        
        _hostApplication.LogDebug(_pluginName, "æ•°æ®å¤„ç†å®Œæˆ");
    }
}
```

---

é€šè¿‡éµå¾ªæœ¬æŒ‡å—ï¼Œæ‚¨å¯ä»¥å……åˆ†åˆ©ç”¨ DTI_Tool.AddIn æ¡†æ¶çš„æ—¥å¿—ç®¡ç†åŠŸèƒ½ï¼Œæ„å»ºå‡ºå¯ç»´æŠ¤ã€å¯ç›‘æ§çš„é«˜è´¨é‡ Excel æ’ä»¶ã€‚

ğŸ’¡ **æç¤º**: ç»“åˆ [æ—¥å¿—ä½¿ç”¨æŒ‡å—](LOGGING_USAGE.md) å’Œ [æ—¥å¿—æµ‹è¯•åŠŸèƒ½æŒ‡å—](LOGGING_TEST_FEATURES.md) ä¸€èµ·é˜…è¯»ï¼Œè·å¾—æ›´å…¨é¢çš„ç†è§£ã€‚ 